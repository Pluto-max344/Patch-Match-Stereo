# **基于PatchMatch算法的立体匹配系统实现报告**

**作者：** [张晗，夏中豪，秦雪莹]

## **引言**

传统的局部立体匹配方法通常假设**支持窗口（support window）内的像素具有恒定视差**，即窗口对应一个**正面平行表面（fronto-parallel surface）**。这一假设在实际场景中常不成立，导致：

- 无法准确重建**倾斜表面**；
- 在**非正面平行结构**上产生阶梯状伪影；
- **亚像素精度**难以实现。

因此提出一种**基于倾斜支持窗口的局部立体匹配方法**，为**每个像素估计一个独立的3D平面**，将支持窗口投影到该平面上进行匹配，从而克服传统方法的“正面平行偏差”。

本项目的目标是完整实现PatchMatch Stereo算法，包括：

1. 基于平面模型的匹配代价计算
2. 权重预计算
3. PatchMatch随机搜索与传播优化
4. 后处理与遮挡填充

## **问题陈述**

### **数据集**

- **输入：** 给定的多对经过极线校正的立体图像（左图和右图），标准深度图
- **数据格式：** 彩色RGB图像
- **分辨率：** 可处理任意分辨率的图像，但计算复杂度随图像尺寸增加

### **预期结果**

- **输出：** 左图像和右图像的稠密视差图
- **精度要求：** 实现亚像素级精度，能够准确重建倾斜表面
- **性能目标：** 在中等分辨率图像上达到可接受的运行时间

### **评估指标**

1. **视觉质量：** 视差图的清晰度、边缘保持能力、倾斜表面重建质量
2. **定量评估：** 在标准数据集（如Middlebury）上的视差误差

 ```python
 # Middlebury标准评估
 bad_pixels_1.0 = (|d_est - d_gt| > 1.0)  # 默认阈值
 bad_pixels_0.5 = (|d_est - d_gt| > 0.5)  # 亚像素精度评估

 # 分区评估
 - nocc: 非遮挡区域
 - all: 所有区域  
 - disc: 深度不连续区域
 ```

3. **算法效率：** 运行时间和内存使用情况

## **技术方法**

### **1. 核心算法框架**

本实现基于原论文的PatchMatch Stereo框架，包含以下核心模块：

#### **A. 平面模型表示**

- 每个像素关联一个三维平面 `f_p`，参数为 `(a_f, b_f, c_f)`
- 平面方程：`d_p = a_f * x + b_f * y + c_f`
- 使用`Plane`类封装平面参数和法向量信息

#### **B. 匹配代价计算**

- **多模态代价函数：** 结合颜色和梯度信息

  ```python
  cost = (1 - α) * min(||I_p - I_q||, τ_col) + α * min(||?I_p - ?I_q||, τ_grad)
  ```

- **自适应权重：** 基于颜色相似性的指数衰减权重

  ```python
  w(p, q) = exp(-||I_p - I_q||_1 / γ)
  ```

#### **C. PatchMatch优化**

- **随机初始化：** 为每个像素随机分配平面参数
- **空间传播：** 在相邻像素间传播平面假设
- **视图传播：** 在左右视图间传播平面参数
- **平面细化：** 随机扰动平面参数，逐步缩小搜索范围

#### **D. 后处理**

- **左右一致性检查：** 检测遮挡和误匹配区域
- **遮挡填充：** 基于最近有效像素的平面外推测视差
- **加权中值滤波：** 平滑填充区域，减少水平条纹

### **2. 实现特点与优化**

#### **A. 向量化加速**

- **关键改进：** 将窗口内像素的匹配代价以及预计算权重向量化
- **原论文方法：** 通常使用嵌套循环遍历窗口内每个像素
- **本实现优化：**
  
  ```python
  # 向量化计算窗口内所有像素的视差
  dsp = p[0] * x_valid + p[1] * y_valid + p[2]
  
  # 批量计算颜色和梯度差异
  cost_c = np.sum(np.abs(f1_vals - mcolo), axis=1)
  cost_g = np.sum(np.abs(g1_vals - mgrad), axis=1)
  ```

#### **B. 权重预计算**

- **创新点：** 预先计算所有像素的支持权重
- **优势：** 避免在每次代价评估时重复计算权重
- **实现：** 使用四维数组存储每个像素在窗口内每个位置的权重

#### **C. 梯度计算优化**

- 使用Sobel算子计算灰度图像梯度
- 存储双通道梯度图（x方向和y方向）

#### **D. 内存管理**

- 设计数据结构，避免不必要的内存分配
- 使用`Matrix2D`类封装二维平面参数数组

## **中级/初步结果**

### **1. 实现完成度**

- ? 完整实现了PatchMatch Stereo算法框架
- ? 实现了平面模型表示和参数估计
- ? 完成了多视图传播和优化，共计迭代三次，一次用时40分钟左右
- ? 实现了完整的后处理流程，用时10分钟
- ? 对聚合匹配代价以及预计算权重进行了初步的numpy向量化优化：优化前预处理部分耗时30分钟，优化后耗时5分钟
- 得到的深度图：  
  左深度图：
  ![左深度图](left_diparity_map.png)

  右深度图：
  ![右深度图](right_disparity_map.png)

### **2. 算法性能特点**

- **优势：**
  - 能够处理倾斜表面，克服正面平行偏差
  - 实现亚像素精度，视差结果为连续值
  - 自适应权重有效处理遮挡区域

- **局限性：**
  - Python实现速度较慢，处理高分辨率图像耗时较长
  - 内存消耗较大，特别是权重预计算需要O(n?)存储
  - 参数调整较为敏感，需要仔细调优

## **下一步计划**

1. **性能优化**
   - 向量化计算加速处理函数与后处理函数
   - 优化边缘问题
   - 实现多线程并行计算,实现GPU并行计算
   - 优化内存使用，减少预计算存储

2. **功能扩展**
   - 添加标准数据集评估接口
